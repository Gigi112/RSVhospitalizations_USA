---
title: "RSV hospitalization burden"
author: "ZHE ZHENG"
date: "3/8/2021"
output: html_document
---

## Load necessary packages

```{r}
library(rjags)
```

## Time-series model structure
```{r}
library(rjags)

model_string<-"
model {

for(k in 1:n.group){  
  for (j in 1:n.age){
    for(n in 1:n.state){
      for (i in 1:n.date) { 
    
   lambda[i,j,k,n] <-   rd0[j,k,n]+
               epi[epi.year[i],j,k,n] +
               delta[month[i],j,k,n] +
               rsv[i,j,k,n]*rd2[j,k,n] + 
               flu[i,j,k,n]*rd1[epi.year[i],j,k,n]+
               phi[i,j,k,n]

  y[i,j,k,n] ~ dpois(lambda[i,j,k,n])  ## likelihood 

  phi[i,j,k,n] ~ dnorm(0,inv_var[i,j,k,n])
  inv_var[i,j,k,n] ~ dgamma(0.01,0.01)

}

  # baseline hospitalizations (must be greater than or equal to 0)
  rd0[j,k,n] <- exp(beta0[j,k,n])
  beta0[j,k,n]~ dnorm(mu0,tau0)
  
  for (p in 1:n.year) { 
    # epi-year effects
    epi[p,j,k,n] ~ dnorm(0, tau1) # random slope

    # coefficient of influenza-associated respiratory hospitalization
    # this coefficient varies annually
    rd1[p,j,k,n] <- exp(beta1[p,j,k,n]) # ensure positive coefs
    beta1[p,j,k,n] <- gamma_flu[k]+ omega_flu[j]+ zeta_flu[n]+ xi_flu[p]+ eta_flu.grp[p,j,k,n] 
    eta_flu.grp[p,j,k,n] ~ dnorm(eta_flu,tau.flu)
    }
  
    # coefficient of RSV-associated respiratory hospitalization
    # this coefficient depends on urbanisity, age and the belonging state
    rd2[j,k,n] <- exp(beta2[j,k,n]) # ensure positive
    beta2[j,k,n] <- gamma[k]+omega[j]+zeta[n]+ eta.grp[j,k,n]
    eta.grp[j,k,n] ~ dnorm(eta,tau.rsv)
  
  
  # Month dummy variable, account for other pathogens and general seasonality 
  for (m in 1:12){
    delta[m,j,k,n] ~ dnorm(epsilon[m,j,k,n],disp.m)
    epsilon[m,j,k,n] <- me[m]
}}}}


## hyperpriors

for(n in 1:n.state){
zeta[n] ~ dnorm(0, tau2)
zeta_flu[n] ~ dnorm(0, tau3)}

for(i in 1:n.group){
gamma_flu[i] ~ dnorm(0, tau4)
gamma[i] ~ dnorm(0, tau5)
}

for(i in 1:n.age){
omega[i] ~ dnorm(0, tau6)
omega_flu[i] ~ dnorm(0,tau7)
}

for(m in 1:12){
  me[m] ~ dnorm(0, tau8)
}

for (p in 1:n.year) { 
xi_flu[p] ~ dnorm(0, tau9)
}
  eta ~ dnorm(0, 0.0001)
  eta_flu ~ dnorm(0, 0.0001)
  mu0 ~ dnorm(0,0.0001)
  tau0 ~ dgamma(0.01, 0.01)
  tau1 ~ dgamma(0.01, 0.01)
  tau2 ~ dgamma(0.01, 0.01)
  tau3 ~ dgamma(0.01, 0.01)
  tau4 ~ dgamma(0.01, 0.01)
  tau5 ~ dgamma(0.01, 0.01)
  tau6 ~ dgamma(0.01, 0.01)
  tau7 ~ dgamma(0.01, 0.01)
  tau8 ~ dgamma(0.01, 0.01)
  tau9 ~ dgamma(0.01, 0.01)
  tau.flu ~ dgamma(0.01, 0.01)
  tau.rsv ~ dgamma(0.01, 0.01)
  disp.m ~ dgamma(0.01, 0.01)
}
"
```


## Posterior sampling
```{r}
epi.year <- as.factor(rep(1:9, each=12))
month <- rep(1:12,9)

dataset <- list('y' = y, "rsv"=rsv,"flu"=flu, 'epi.year'=epi.year,"month"=month,n.age=9,n.date=108,n.year=9,"n.group"=3,n.state=3)

jags_post <- jags.model(textConnection(model_string), data = dataset,
                   n.adapt = 2000, n.chains = 2)

 update(jags_post, 
         n.iter=5000)


  rsv_resp <- coda.samples(jags_post, variable.names=c("rd2","lambda","rd1","phi", "rd0","epi","delta"),
                      thin = 10,n.iter = 10000)
```

## Calculate RSV attributable respiratory hospitalization incidence and percent
```{r}
  post <- as.data.frame(as.matrix(rsv_resp))
  lambda <- post[, grep("lambda", colnames(post), fixed=T)]
  rd2.resp <- post[, grep("rd2[", colnames(post), fixed=T)]
  
  rsv_count_nj <- array(data = NA,dim = c(2000,108,9,3))
for (i in 1:108) {
  for (j in 1:9) {
    for (k in 1:3) {
      rsv_count_nj[,i,j,k] <- rsv[i,j,k,1]*rd2.resp[,j+9*(k-1)]
    }}}

rsv_count_ny <- array(data = NA,dim = c(2000,108,9,3))
for (i in 1:108) {
  for (j in 1:9) {
    for (k in 1:3) {
      rsv_count_ny[,i,j,k] <- rsv[i,j,k,2]*rd2.resp[,j+9*(k-1)+27]
    }}}

rsv_count_wa <- array(data = NA,dim = c(2000,108,9,3))
for (i in 1:108) {
  for (j in 1:9) {
    for (k in 1:3) {
      rsv_count_wa[,i,j,k] <- rsv[i,j,k,3]*rd2.resp[,j+9*(k-1)+54]
    }}}

rsv_percent_nj <- array(data = NA,dim = c(2000,9,3))
for (j in 1:9) {
  for (k in 1:3) {
    rsv_percent_nj[,j,k] <- as.numeric(rowSums(rsv_count_nj[,,j,k])/rowSums(lambda[,((j-1)*108+(k-1)*108*9+1):((j-1)*108+(k-1)*108*9+108)]))
  }}

rsv_percent_ny <- array(data = NA,dim = c(2000,9,3))
for (j in 1:9) {
  for (k in 1:3) {
    rsv_percent_ny[,j,k] <- as.numeric(rowSums(rsv_count_ny[,,j,k])/rowSums(lambda[,((j-1)*108+(k-1)*108*9+1+2916):((j-1)*108+(k-1)*108*9+108+2916)]))
  }}

rsv_percent_wa <- array(data = NA,dim = c(2000,9,3))
for (j in 1:9) {
  for (k in 1:3) {
    rsv_percent_wa[,j,k] <- as.numeric(rowSums(rsv_count_wa[,,j,k])/rowSums(lambda[,((j-1)*108+(k-1)*108*9+1+5832):((j-1)*108+(k-1)*108*9+108+5832)]))
  }}

resp_nj <- array(data = NA,dim = c(2000,9,3))
for (j in 1:9) {
  for (k in 1:3) {
    resp_nj[,j,k] <- as.numeric(rowSums(lambda[,((j-1)*108+(k-1)*108*9+1):((j-1)*108+(k-1)*108*9+108)]))
  }}

resp_ny <- array(data = NA,dim = c(2000,9,3))
for (j in 1:9) {
  for (k in 1:3) {
    resp_ny[,j,k] <- as.numeric(rowSums(lambda[,((j-1)*108+(k-1)*108*9+1+2916):((j-1)*108+(k-1)*108*9+108+2916)]))
  }}

resp_wa <- array(data = NA,dim = c(2000,9,3))
for (j in 1:9) {
  for (k in 1:3) {
    resp_wa[,j,k] <- as.numeric(rowSums(lambda[,((j-1)*108+(k-1)*108*9+1+5832):((j-1)*108+(k-1)*108*9+108+5832)]))
  }}
```
